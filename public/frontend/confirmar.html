<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
// ===== SUPABASE =====
const supabaseUrl = "https://pasllgbgvrffylrsvzgo.supabase.co";
const supabaseKey = "sb_publishable_IjrT6_ewTkVnyt54DZvZgA_3vYl3Ok1"; 
const supabase = supabase.createClient(supabaseUrl, supabaseKey);

// ===== Função para adicionar nova pessoa =====
function adicionarPessoa() {
    const lista = document.getElementById("lista-pessoas");
    const div = document.createElement("div");
    div.className = "pessoa";
    div.innerHTML = `
        <input type="text" placeholder="Nome">
        <div class="erro"></div>

        <input type="text" placeholder="Sobrenome">
        <div class="erro"></div>

        <button type="button" class="remover">✕</button>
    `;
    lista.appendChild(div);

    div.querySelector(".remover").addEventListener("click", () => div.remove());
}

// ===== Espera a página carregar =====
document.addEventListener("DOMContentLoaded", () => {

    document.getElementById("adicionar").addEventListener("click", adicionarPessoa);

    document.getElementById("confirmar").addEventListener("click", async () => {

        const divs = document.querySelectorAll("#lista-pessoas .pessoa");

        const pessoas = [...divs].map(div => ({
            nome: div.querySelector('input[placeholder="Nome"]').value.trim(),
            sobrenome: div.querySelector('input[placeholder="Sobrenome"]').value.trim()
        }));

        // ===== Validação =====
        let valido = true;

        pessoas.forEach((pessoa, i) => {
            const erros = divs[i].querySelectorAll(".erro");
            erros.forEach(e => e.textContent = "");

            if (!pessoa.nome) {
                erros[0].textContent = "Nome obrigatório";
                valido = false;
            }
            if (!pessoa.sobrenome) {
                erros[1].textContent = "Sobrenome obrigatório";
                valido = false;
            }
        });

        if (!valido) return;

        if (!confirm("Tem certeza que deseja confirmar a presença?")) return;

        // ===== ENVIA PARA SUPABASE =====
        const { error } = await supabase
            .from("presencas")
            .insert(pessoas);

        if (error) {
            console.error(error);
            alert("Erro ao confirmar presença.");
            return;
        }

        alert("Presença confirmada com sucesso! ❤️");

        // ===== REDIRECIONA =====
        window.location.href = "localizacao.html";
    });
});
</script>
